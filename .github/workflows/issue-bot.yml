name: AI Issue Bot

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  respond:
    runs-on: ubuntu-latest

    steps:
      - name: Use GitHub Script with OpenRouter
        uses: actions/github-script@v6
        with:
          script: |
            const message = context.eventName === 'issues'
              ? `Issue Title: ${context.payload.issue.title}\nIssue Body: ${context.payload.issue.body}`
              : `Comment: ${context.payload.comment.body}`;

            const issueNumber = context.payload.issue.number;
            const prompt = `You are a professional backend developer bot named RatheeshBot. Help answer this GitHub query politely and helpfully:\n\n${message}`;
            const openRouterKey = process.env.OPENROUTER_API_KEY;

            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${openRouterKey}`,
                'Content-Type': 'application/json',
                'HTTP-Referer': 'https://github.com/ratheeshkumar25',
                'X-Title': 'GitHub Issue Bot'
              },
              body: JSON.stringify({
                model: 'mistralai/mistral-7b-instruct',
                messages: [
                  { role: 'system', content: 'You are RatheeshBot, a helpful backend development assistant.' },
                  { role: 'user', content: prompt }
                ]
              })
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`OpenRouter API error (${response.status}): ${errorText}`);
            }

            const data = await response.json();
            const reply = data.choices?.[0]?.message?.content || "Sorry, I couldn't generate a reply.";

            await github.rest.issues.createComment({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: reply
            });

        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
